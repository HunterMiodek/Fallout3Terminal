#!/usr/bin/env bash

BASE_DIR="$(cd "$(dirname "$0")"; pwd)" || exit 2

# File to store the password
PASSWORD_FILE="$BASE_DIR/password.txt"

# Set an initial password if the password file does not exist
if [ ! -f "$PASSWORD_FILE" ]; then
    echo "Enter an initial password:"
    read -s initial_password
    echo "$initial_password" > "$PASSWORD_FILE"
fi

# Function to check the password
check_password() {
    local input_password
    read -sp "Enter password: " input_password
    echo

    # Read the stored password from file
    local stored_password
    stored_password=$(<"$PASSWORD_FILE")

    if [ "$input_password" == "$stored_password" ]; then
        return 0
    else
        echo "Incorrect password. Please try again."
        return 1
    fi
}

# Function to change the password
change_password() {
    read -sp "Enter new password: " new_password
    echo
    echo "$new_password" > "$PASSWORD_FILE"
    echo "Password changed successfully."
}

# Function to display login page
login() {
    while ! check_password; do
        echo "Failed to login. Try again."
    done
}

# Your existing functions here...

# Main Menu Screen
mainmenufunc () {
    clear
    display_center "$BASE_DIR/greeterheader.txt" | pv -qL 80
    echo "$greeter" | pv -qL 80
    echo What would you like to do? | pv -qL 80

    # Define the menu options including new options
    options=("View Journal Entries" "Log a Journal Entry" "Delete a Journal Entry" "Network Settings" "Change Password" "Return to Login Page" "Proceed to Desktop")

    # Use fzf to display the options
    menuchoice=$(printf "%s\n" "${options[@]}" | fzf --height=10 --border --layout=reverse)

    case $menuchoice in
        "View Journal Entries")
            viewentriesfunc
            ;;
        "Log a Journal Entry")
            writeentryfunc
            ;;
        "Delete a Journal Entry")
            deleteentryfunc
            ;;
        "Network Settings")
            networkfunc
            ;;
        "Change Password")
            change_password
            ;;
        "Return to Login Page")
            login
            ;;
        "Proceed to Desktop")
            echo Goodbye! && exit
            ;;
        *)
            repeatmainmenufunc
            ;;
    esac
}

# Add the login call before launching the main menu
login

# Some random aesthetic startup text
clear
echo "Initializing boot..." | pv -qL 80
sleep 0.4
echo "Loading Federal Terminal OS..."  | pv -qL 80
sleep 0.4
echo "64K RAM detected..."  | pv -qL 80
sleep 0.4
echo "Launching Interface..."  | pv -qL 80
sleep 0.4
clear
echo $'
 _  _  ____  __     ___  __   _  _  ____ 
/ )( \(  __)(  )   / __)/  \ ( \/ )(  __)
\ /\ / ) _) / (_/\( (__(  O )/ \/ \ ) _) 
(_/\_)(____)\____/ \___)\__/ \_)(_/(____)
'

echo "==============================================" | pv -qL 50
sleep 1

# Launch the main menu
mainmenufunc
